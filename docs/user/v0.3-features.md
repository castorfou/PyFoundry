# Nouveaut√©s v0.3 - Qualit√© de Code

La version 0.3 de PyFoundry introduit un syst√®me complet d'**assurance qualit√© automatis√©e** avec les outils modernes de l'√©cosyst√®me Python.

## üéØ Objectifs de la v0.3

- **Qualit√© de code automatis√©e** : Linting, formatage et v√©rification de types
- **Pre-commit hooks** : Validation automatique avant chaque commit
- **Configuration zero-config** : Pr√™t √† l'emploi avec des r√®gles adapt√©es Data Science
- **Standards industriels** : Ruff + MyPy pour une qualit√© professionnelle

## üöÄ Nouvelles fonctionnalit√©s

### Ruff - Linter et Formateur Moderne

Ruff remplace plusieurs outils traditionnels en un seul :
- ‚úÖ **Linting** (remplace flake8, pylint)
- ‚úÖ **Formatage** (remplace black)  
- ‚úÖ **Import sorting** (remplace isort)
- ‚úÖ **Mise √† jour syntaxe** (remplace pyupgrade)

#### Configuration adapt√©e Data Science

```toml
[tool.ruff]
extend-select = [
    "E", "W",    # pycodestyle
    "F",         # pyflakes
    "I",         # isort
    "UP",        # pyupgrade
    "B",         # flake8-bugbear
    "PD",        # pandas-vet
    "NPY",       # numpy-specific
]

ignore = [
    "PD901",     # df comme nom de variable (OK en DS)
    "E501",      # Longueur de ligne (ruff format g√®re)
]
```

#### R√®gles sp√©cifiques par contexte

```toml
[tool.ruff.lint.per-file-ignores]
"notebooks/*.py" = ["E402", "F401"]  # Imports flexibles en notebooks
"scripts/*.py" = ["T201"]           # print() OK dans scripts
"tests/*.py" = ["S101"]             # assert OK en tests
```

### MyPy - V√©rification de Types

Configuration progressive adapt√©e aux projets Data Science :

```toml
[tool.mypy]
# Configuration stricte progressive
disallow_incomplete_defs = true      # Fonctions partiellement typ√©es interdites
warn_return_any = true              # Warnings sur types Any
warn_unused_ignores = true          # Nettoyage annotations inutiles

# Tol√©rance pour d√©buter
disallow_untyped_defs = false       # Autoris√© au d√©but
disallow_untyped_calls = false      # Autoris√© au d√©but
```

#### Support biblioth√®ques Data Science

```toml
[[tool.mypy.overrides]]
module = [
    "matplotlib.*",
    "seaborn.*", 
    "sklearn.*",
    "scipy.*",
]
ignore_missing_imports = true
```

### Pre-commit Hooks Automatis√©s

Configuration compl√®te dans `.pre-commit-config.yaml` :

#### Hooks standards
- ‚úÖ **Trailing whitespace** - Supprime espaces fins de ligne
- ‚úÖ **End-of-file-fixer** - Ligne vide en fin de fichier
- ‚úÖ **Check YAML/TOML/JSON** - Validation syntaxe
- ‚úÖ **Large files** - Pr√©vention gros fichiers (500KB max)

#### Hooks qualit√© Python  
- ‚úÖ **Ruff linting** - Correction automatique des erreurs
- ‚úÖ **Ruff format** - Formatage uniforme du code
- ‚úÖ **MyPy** - V√©rification types sur `src/` uniquement

#### Hooks s√©curit√©
- ‚úÖ **detect-secrets** - D√©tection secrets/tokens dans le code

### Exclusions Intelligentes

Les hooks excluent automatiquement :
```yaml
exclude: |
  (?x)^(
      data/.*|              # Donn√©es
      models/.*|            # Mod√®les ML  
      logs/.*|              # Logs
      \.jupyter/.*|         # Config Jupyter
  )$
```

## üõ†Ô∏è Utilisation

### Workflow automatis√© complet

La v0.3 automatise compl√®tement la configuration qualit√© :

```bash
# 1. G√©n√©ration du projet avec param√®tres GitHub
cruft create https://github.com/castorfou/PyFoundry.git
# ‚Üí Demande github_username pour la configuration automatique

# 2. Ouverture en devcontainer (recommand√©)  
code mon-projet
# ‚Üí VS Code propose "Reopen in Container"
# ‚Üí Le devcontainer configure automatiquement :
#   - Environnement Python + d√©pendances
#   - Git init avec branche main
#   - Pre-commit hooks install√©s et pr√©-compil√©s
#   - Authentification GitHub via gh auth login
#   - Remote origin configur√©
#   - Commit initial avec hooks actifs
```

### Authentification GitHub automatique

Lors du premier setup du devcontainer :

```bash
üîê Authentification GitHub requise pour push/pull
Lancement de l'authentification...

Suivez les instructions pour vous connecter √† GitHub :
? What account do you want to log into? GitHub.com
? What is your preferred protocol for Git operations? HTTPS
? Authenticate Git with your GitHub credentials? Yes
? How would you like to authenticate GitHub CLI? Login with a web browser
```

**Une fois authentifi√©** ‚Üí `git push` et `git pull` fonctionnent sans intervention !

### Commandes de qualit√©

```bash
# Linting avec correction automatique
ruff check . --fix

# Formatage du code
ruff format .

# V√©rification de types
mypy src/

# V√©rification compl√®te (comme pre-commit)
ruff check . && ruff format . && mypy src/
```

### Workflow de d√©veloppement

```bash
# 1. D√©veloppement normal
echo "def hello(): print('world')" > src/example.py

# 2. Commit d√©clenche automatiquement les hooks
git add .
git commit -m "feat: add hello function"

# Output automatique :
# ‚úÖ trailing-whitespace............................Passed
# ‚úÖ ruff (lint)..................................Passed  
# ‚úÖ ruff (format)................................Passed
# ‚úÖ mypy (type check)...........................Passed
```

## üìä Am√©liorations apport√©es

### Performance des hooks

| Hook | Temps moyen | Couverture |
|------|-------------|------------|
| ruff check | ~1s | Tout Python |
| ruff format | ~0.5s | Tout Python |
| mypy | ~3s | src/ uniquement |
| detect-secrets | ~2s | Tous fichiers |

### Qualit√© de code

- **0 warnings** sur code g√©n√©r√© par d√©faut
- **Formatage uniforme** automatique
- **Types explicites** encourag√©s (pas forc√©s)
- **Standards industriels** respect√©s

### Int√©gration VS Code

Extensions recommand√©es automatiquement :
- **Ruff** - Linting et formatage en temps r√©el
- **MyPy** - V√©rification types inline
- **Pre-commit** - Hooks visibles dans l'interface

## üîß Configuration avanc√©e

### Personnaliser les r√®gles Ruff

```toml
# Ajouter des r√®gles sp√©cifiques
[tool.ruff]
extend-select = ["C90"]  # Complexit√© cyclomatique
ignore = ["E203"]        # Ignorer r√®gle sp√©cifique

# R√®gles par r√©pertoire
[tool.ruff.lint.per-file-ignores]
"src/legacy/*.py" = ["F401", "F841"]  # Code legacy plus permissif
```

### Adapter MyPy progressivement

```toml
# Devenir plus strict avec le temps
[tool.mypy]
disallow_untyped_defs = true         # Activer quand pr√™t
disallow_any_generics = true         # Types g√©n√©riques stricts
strict_optional = true               # None explicite
```

### Hooks personnalis√©s

```yaml
# Ajouter dans .pre-commit-config.yaml
- repo: local
  hooks:
    - id: jupyter-nb-clear-output
      name: Clear Jupyter notebook outputs
      entry: jupyter nbconvert --ClearOutputPreprocessor.enabled=True --inplace
      language: system
      files: \.ipynb$
```

## üêõ Troubleshooting

### Setup devcontainer √©choue

```bash
# V√©rifier les logs du postCreateCommand
# Dans VS Code: View > Output > Dev Containers

# Probl√®mes courants :
# 1. docker login ghcr.io requis pour uv feature
# 2. Connexion r√©seau pour t√©l√©charger les d√©pendances
# 3. Authentification GitHub interrompue
```

### Pre-commit hooks √©chouent

```bash
# Hooks pr√©-install√©s mais erreur au commit
pre-commit run --all-files --verbose

# R√©installer les environnements si n√©cessaire
pre-commit clean
pre-commit install-hooks

# Bypasser temporairement (d√©conseill√©)
git commit -m "message" --no-verify
```

### Authentification GitHub √©choue

```bash
# V√©rifier le statut d'authentification
gh auth status

# Re-authentifier si n√©cessaire  
gh auth login --git-protocol https --web

# Alternative : utiliser token personnel dans URL
git remote set-url origin https://username:token@github.com/user/repo.git
```

### MyPy trouve trop d'erreurs

```bash
# Configuration progressive - commencer permissif
# Dans pyproject.toml:
[tool.mypy]
disallow_untyped_defs = false    # Commencer par false
disallow_incomplete_defs = true  # Puis activer progressivement
```

## üéØ Prochaines √©tapes

La v0.3 pr√©pare le terrain pour :

- **v0.4** : Tests automatis√©s (pytest, coverage, pytest-cookies)
- **v0.5** : CI/CD complet (GitHub Actions, releases automatis√©es)

### Migration depuis v0.2

```bash
# 1. Mettre √† jour le template
cruft update

# 2. Installer les nouvelles d√©pendances
uv pip install -e .[dev]

# 3. Configurer pre-commit
pre-commit install

# 4. Premier passage (peut g√©n√©rer des changements)
pre-commit run --all-files
```

---

**üìö Ressources utiles :**
- [Configuration Ruff](https://docs.astral.sh/ruff/configuration/)
- [MyPy documentation](https://mypy.readthedocs.io/)
- [Pre-commit hooks](https://pre-commit.com/hooks.html)
- [Roadmap v0.4](../dev/roadmap.md)