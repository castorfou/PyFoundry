# Guide d'implÃ©mentation v0.3 - QualitÃ© de Code

## ğŸ¯ Vue d'ensemble

La v0.3 apporte un systÃ¨me complet d'assurance qualitÃ© **zero-config** avec :
- Configuration automatique des outils de qualitÃ©
- IntÃ©gration Git/GitHub seamless  
- Pre-commit hooks optimisÃ©s pour la performance
- Workflow entiÃ¨rement automatisÃ©

## ğŸ”§ Architecture technique

### Composants principaux

```
{{ cookiecutter.project_slug }}/
â”œâ”€â”€ .devcontainer/
â”‚   â”œâ”€â”€ devcontainer.json          # Features + mounts + config
â”‚   â””â”€â”€ postCreateCommand.sh       # Setup automatisÃ©
â”œâ”€â”€ .pre-commit-config.yaml        # 4 repos avec versions rÃ©centes
â”œâ”€â”€ pyproject.toml                 # Configuration ruff + mypy
â””â”€â”€ cookiecutter.json              # Nouveau paramÃ¨tre github_username
```

### Workflow d'initialisation

```mermaid
graph TD
    A[cruft create] --> B[GÃ©nÃ©ration projet]
    B --> C[code projet]
    C --> D[VS Code: Reopen in Container]
    D --> E[postCreateCommand.sh]
    E --> F[Setup Python + deps]
    F --> G[Git init --initial-branch=main]
    G --> H[pre-commit install + install-hooks]
    H --> I[gh auth login]
    I --> J[Commit initial avec hooks]
    J --> K[Projet prÃªt !]
```

## ğŸ› ï¸ ImplÃ©mentation dÃ©taillÃ©e

### 1. Configuration devcontainer

#### Features ajoutÃ©es
```json
"features": {
    "ghcr.io/va-h/devcontainers-features/uv:1": {},
    "ghcr.io/devcontainers/features/github-cli:1": {},
    "ghcr.io/devcontainers/features/git:1": {
        "ppa": true  // Pour git credential manager
    }
}
```

#### Montages pour hÃ©ritage config
```json
"mounts": [
    "source=${localEnv:HOME}/.gitconfig,target=/home/vscode/.gitconfig,type=bind,consistency=cached,readonly",
    "source=${localEnv:HOME}/.ssh,target=/home/vscode/.ssh,type=bind,consistency=cached,readonly"
]
```

### 2. Configuration pre-commit optimisÃ©e

#### Repos avec versions rÃ©centes
```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0      # Auto-mise Ã  jour via pre-commit autoupdate
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.12.10    # DerniÃ¨re version stable
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.17.1     # Compatible Python 3.11+
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0      # Sans baseline pour simplifier
```

#### Optimisations performance
- `pre-commit install-hooks` pendant le setup
- Exclusions intelligentes (`data/`, `models/`, `.jupyter/`)
- `default_stages: [pre-commit]` (pas deprecated)

### 3. Configuration ruff adaptÃ©e Data Science

#### RÃ¨gles sÃ©lectionnÃ©es
```toml
[tool.ruff]
extend-select = [
    "E", "W",    # pycodestyle
    "F",         # pyflakes  
    "I",         # isort
    "UP",        # pyupgrade
    "B",         # bugbear
    "PD",        # pandas-vet ğŸ†•
    "NPY",       # numpy-specific ğŸ†•
]

ignore = [
    "PD901",     # df variable name OK en DS
    "E501",      # Line length gÃ©rÃ© par formatter
]
```

#### RÃ¨gles par contexte
```toml
[tool.ruff.lint.per-file-ignores]
"notebooks/*.py" = ["E402", "F401", "F841"]  # Notebooks plus permissifs
"scripts/*.py" = ["T201"]                    # print() OK dans scripts  
"tests/*.py" = ["S101", "PLR2004"]          # assert OK en tests
```

### 4. Configuration mypy progressive

#### Setup dÃ©butant-friendly
```toml
[tool.mypy]
# Strict sur les fondamentaux
disallow_incomplete_defs = true      # Pas de fonction partiellement typÃ©e
warn_return_any = true              # Warning sur Any

# Permissif pour commencer  
disallow_untyped_defs = false       # Fonction non-typÃ©es OK
disallow_untyped_calls = false      # Appels non-typÃ©s OK
```

#### Overrides pour Data Science
```toml
[[tool.mypy.overrides]]
module = ["matplotlib.*", "seaborn.*", "sklearn.*", "scipy.*"]
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "notebooks.*"
ignore_errors = true               # Notebooks exempts
```

## ğŸ”„ Gestion des erreurs et edge cases

### 1. Commit avec modifications des hooks

ProblÃ¨me : Pre-commit peut modifier les fichiers pendant le commit, causant l'Ã©chec.

Solution dans `postCreateCommand.sh` :
```bash
if ! git commit -m "update pre-commit hooks" 2>/dev/null; then
    echo "Ajout des corrections de formatage..."
    git add .
    git commit -m "update pre-commit hooks and fix formatting" || true
fi
```

### 2. Authentification GitHub interrompue

ProblÃ¨me : L'utilisateur peut interrompre `gh auth login`.

Solution : Check status + guidance claire :
```bash
if ! gh auth status &>/dev/null; then
    echo "ğŸ” Authentification GitHub requise pour push/pull"
    echo "Lancement de l'authentification..."
    gh auth login --git-protocol https --web
fi
```

### 3. detect-secrets sans baseline

ProblÃ¨me : detect-secrets cherche `.secrets.baseline` qui n'existe pas.

Solution : Supprimer `--baseline` argument, utiliser uniquement exclusions.

## ğŸ“Š Performance et optimisations

### Temps de setup optimisÃ©s

| Composant | v0.2 | v0.3 | AmÃ©lioration |
|-----------|------|------|--------------|
| Setup Python | ~30s | ~30s | = |
| Pre-commit install | ~2minâ½Â¹â¾ | ~2min | = |
| **Total perception** | **~2min** | **~30s** | **75% plus rapide** |

â½Â¹â¾ Mais maintenant fait pendant le setup, pas Ã  la premiÃ¨re utilisation

### StratÃ©gies d'optimisation

1. **Pre-install hooks** : `pre-commit install-hooks` pendant setup
2. **Versions rÃ©centes** : Ã‰vite les mises Ã  jour majeures
3. **Exclusions intelligentes** : Ã‰vite de scanner `data/`, `models/`
4. **Montages cached** : Config git hÃ©ritÃ©e sans copie

## ğŸ§ª Tests et validation

### ScÃ©narios de test

1. **Happy path** : GÃ©nÃ©ration â†’ Devcontainer â†’ Auth â†’ Commit â†’ Push
2. **Auth Ã©choue** : Skip auth mais setup continue
3. **Pre-commit modifie fichiers** : Commit automatique des corrections
4. **Versions dÃ©jÃ  rÃ©centes** : Pas de mise Ã  jour inutile

### Validation qualitÃ©

```bash
# Dans projet gÃ©nÃ©rÃ© :
ruff check .                 # â†’ 0 erreurs
ruff format . --check        # â†’ DÃ©jÃ  formatÃ©  
mypy src/                    # â†’ 0 erreurs (sur code minimal)
pre-commit run --all-files   # â†’ All passed, 0 warnings
```

## ğŸ”® Points d'extension v0.4+

### Hooks additionnels possibles
- `jupyter-nb-clear-output` pour nettoyer notebooks
- `check-requirements-txt` pour cohÃ©rence deps
- `bandit` pour sÃ©curitÃ© Python avancÃ©e

### Configuration avancÃ©e
- Profils ruff par environnement (dev/prod)
- MyPy strict mode progressif par module
- Integration avec IDEs (PyCharm, etc.)

---

**ğŸ“ Fichiers clÃ©s modifiÃ©s :**
- `cookiecutter.json` : +github_username
- `.devcontainer/devcontainer.json` : +features, +mounts
- `.devcontainer/postCreateCommand.sh` : +git setup, +pre-commit, +auth
- `.pre-commit-config.yaml` : Nouveau fichier complet
- `pyproject.toml` : +[tool.ruff], +[tool.mypy], +deps dev
- `docs/user/v0.3-features.md` : Documentation utilisateur